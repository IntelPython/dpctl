.. _dpctl_capi:

:py:mod:`dpctl` C API
=====================

:py:mod:`dpctl` core classes are implemented in Cython. C declarations for Python objects
corresponding to these classes, as well as their Python types are generated by Cython.

Exported typedefs
-----------------

.. c:struct:: PySyclDeviceObject

.. c:struct:: PySyclDeviceType

.. c:struct:: PySyclContextObject

.. c:struct:: PySyclContextType

.. c:struct:: PySyclQueueObject

.. c:struct:: PySyclQueueType

.. c:struct:: PySyclEventObject

.. c:struct:: PySyclEventType

.. c:struct:: Py_MemoryObject

.. c:struct:: Py_MemoryType

.. c:struct:: PySyclKernelObject

.. c:struct:: PySyclKernelType

.. c:struct:: PySyclProgramObject

.. c:struct:: PySyclProgramType

To check whether a particular Python object is an instance of :py:class:`dpctl.SyclQueue`:

.. code-block:: C
    :caption: Check if an object is of type :c:struct:`PySyclQueueType`

    #include "Python.h"
    #include "dpctl_capi.h"

    int PySyclQueue_Check(PyObject *o) {
        return PyObject_TypeCheck(o, &PySyclQueueType);
    }

API for :c:struct:`PySyclDeviceObject`
--------------------------------------

.. c:function:: DPCTLSyclDeviceRef SyclDevice_GetDeviceRef(struct PySyclDeviceObject *o)

    :param o: Input object
    :returns: borrowed instance of :c:struct:`DPCTLSyclDeviceRef`

.. c:function:: struct PySyclDeviceObject * SyclDevice_Make(DPCTLSyclDeviceRef DRef)

    :param DRef: instance of :c:struct:`DPCTLSyclDeviceRef`
    :returns: new Python object of type :c:struct:`PySyclDeviceType`

    Note that function does not change the ownership of the ``DRef`` instance and
    the caller remains responsible for freeing ``DRef`` as appropriate.

API for :c:struct:`PySyclContextObject`
---------------------------------------

.. c:function:: DPCTLSyclContextRef SyclContext_GetContextRef(struct PySyclContextObject *o)

    :param o: Input object
    :returns: borrowed instance of :c:struct:`DPCTLSyclContextRef`

.. c:function:: struct PySyclContextObject * SyclContext_Make(DPCTLSyclContextRef CRef)

    :param CRef: instance of :c:struct:`DPCTLSyclContextRef`
    :returns: new Python object of type :c:struct:`PySyclContextType`

    Note that function does not change the ownership of the ``CRef`` instance and
    the caller remains responsible for freeing ``CRef`` as appropriate.

API for :c:struct:`PySyclQueueObject`
-------------------------------------

.. c:function:: DPCTLSyclQueueRef SyclQueue_GetQueueRef(struct PySyclQueueObject *o)

    :param o: Input object
    :returns: borrowed instance of :c:struct:`DPCTLSyclQueueRef`

.. c:function:: struct PySyclQueueObject * SyclQueue_Make(DPCTLSyclQueueRef QRef)

    :param QRef: instance of :c:struct:`DPCTLSyclQueueRef`
    :returns: new Python object of type :c:struct:`PySyclQueueType`

    Note that function does not change the ownership of the ``QRef`` instance and
    the caller remains responsible for freeing ``QRef`` as appropriate.

API for :c:struct:`PySyclEventObject`
-------------------------------------

.. c:function:: DPCTLSyclEventRef SyclEvent_GetEventRef(struct PySyclEventObject *o)

    :param o: Input object
    :returns: borrowed instance of :c:struct:`DPCTLSyclEventRef`

.. c:function:: struct PySyclEventObject * SyclEvent_Make(DPCTLSyclEventRef ERef)

    :param ERef: instance of :c:struct:`DPCTLSyclEventRef`
    :returns: new Python object of type :c:struct:`PySyclEventType`

    Note that function does not change the ownership of the ``ERef`` instance and
    the caller remains responsible for freeing ``ERef`` as appropriate.

API for :c:struct:`Py_MemoryObject`
-----------------------------------

.. c:function:: DPCTLSyclUSMRef Memory_GetUsmPointer(struct Py_MemoryObject *o)

    :param o: Input object
    :returns: Opaque pointer to USM allocation represented by Python object.

.. c:function:: DPCTLSyclContextRef Memory_GetSyclContext(struct Py_MemoryObject *o)

    :param o: Input object
    :returns: Returns borrowed instance of :c:struct:`PySyclContextRef` corresponding
        to ``sycl::context`` to which USM allocation represented by input Python object
        is bound.

.. c:function:: DPCTLSyclQueueRef Memory_GetSyclQueue(struct Py_MemoryObject *o)

    :param o: Input object
    :returns: Returns borrowed instance of :c:struct:`PySyclQueueRef` corresponding
        to ``sycl::queue`` associated with input Python object.

    The ``sycl::queue`` uses the same ``sycl::context`` to which the USM allocation
    represented by input Python object is bound.

.. c:function:: size_t Memory_GetNumBytes(struct Py_MemoryObject *o)

    :param o: Input object
    :returns: Size of USM allocation in bytes.

.. c:function:: struct Py_MemoryObject * Memory_Make(DPCTLSyclUSMRef ptr, size_t nbytes, DPCTLSyclQueueRef QRef, PyObject *owner)

    :param ptr: Opaque pointer in unified address space
    :param nbytes: The size of allocation in bytes
    :param QRef: instance of :c:struct:`PySyclQueueRef` corresponding
        to ``sycl::queue`` to be associated with this allocation
    :param owner: Python object instance whose deleter triggers freeing of this USM allocation. Specify `owner=None`
        to pass ownership to created Python memory object, which will use ``sycl::free(ptr, sycl_queue)`` for
        deallocation.

.. c:function:: void * Memory_GetOpaquePointer(struct Py_MemoryObject *o)

    :param o: Input object
    :returns: Returns opaque pointer to `std::shared_ptr<void>` which manages the USM allocation,
        or a `nullptr` if the USM allocation represented by `o` is not managed by the smart
        pointer.

API for :c:struct:`PySyclKernelObject`
--------------------------------------

.. c:function:: DPCTLSyclKernelRef SyclKernel_GetKernelRef(struct PySyclKernelObject *krn)

    :param krn: Input object
    :returns: borrowed instance of :c:struct:`DPCTLSyclKernelRef` corresponding to ``sycl::kernel``

.. c:function:: struct PySyclKernelObject * SyclKernel_Make(DPCTLSyclKernelRef KRef)

    :param KRef: instance of :c:struct:`DPCTLSyclKernelRef`
    :returns: new Python object of type :c:struct:`PySyclKernelType`

    Note that function does not change the ownership of the ``KRef`` instance and
    the caller remains responsible for freeing ``KRef`` as appropriate.


API for :c:struct:`PySyclProgramObject`
---------------------------------------

.. c:function:: DPCTLSyclKernelBundleRef SyclProgram_GetKernelBundleRef(struct PySyclProgramObject *prog)

    :param prog: Input object
    :returns: borrowed instance of :c:struct:`DPCTLSyclKernelBundleRef` corresponding
        to ``sycl::kernel_bundle<sycl::bundle_state::executable>``

.. c:function:: struct PySyclProgramObject * SyclProgram_Make(DPCTLSyclKernelBundleRef KBRef)

    :param KBRef: instance of :c:struct:`DPCTLSyclKernelBundleRef`
    :returns: new Python object of type :c:struct:`PySyclProgramType`

    Note that function does not change the ownership of the ``KBRef`` instance and
    the caller remains responsible for freeing ``KBRef`` as appropriate.
